FROM nvidia/cudagl:10.0-devel-ubuntu18.04
LABEL maintainer "SJTU-lxd"

# docker build . -t inmoovsrl:v3.0
# docker run -it --runtime=nvidia -v /tmp/.X11-unix:/tmp/.X11-unix -v /data:/data -v /etc/localtime:/etc/localtime -v /code:/root/project -e DISPLAY=unix$DISPLAY -p 50001:22 -p 27017:27017 --name SSH1 inmoovsrl:v3.0
# python -m rl_baselines.train --env OmnirobotEnv-v0 --algo ppo2 --log-dir logs/test/ --srl-model ground_truth --no-vis
# python -m replay.enjoy_baselines --log-dir logs/dockertest/OmnirobotEnv-v0/ground_truth/ppo2/19-12-25_02h12_39/ --render --action-proba

ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8
ENV PATH /usr/local/anaconda3/bin:$PATH

#Installs dependencies.
RUN export DEBIAN_FRONTEND=noninteractive && apt-get update && apt-get install -y \
        sudo glmark2 mesa-utils \
	libopenmpi-dev openmpi-bin openmpi-doc cmake libz-dev \
	wget bzip2 ca-certificates \
	libglib2.0-0 libxext6 libsm6 libxrender1 \
	git mercurial subversion \
	swig && \
    rm -rf /var/lib/apt/lists/*

#Installs Anaconda
RUN wget --quiet https://repo.anaconda.com/archive/Anaconda3-5.3.0-Linux-x86_64.sh -O ~/anaconda.sh && \
    /bin/bash ~/anaconda.sh -b -p /usr/local/anaconda3 && \
    rm ~/anaconda.sh && \
    ln -s /usr/local/anaconda3/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
    echo ". /usr/local/anaconda3/etc/profile.d/conda.sh" >> ~/.bashrc

#Creates conda SRL environment
COPY origin /root/origin
RUN conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/pytorch/ && \
    conda env create --file ~/origin/robotics-rl-srl/environment.yml && \
    echo "conda activate py35" >> ~/.bashrc && \
    pip install ipdb && \
    cp /usr/local/anaconda3/x86_64-conda_cos6-linux-gnu/sysroot/lib/libstdc++.so.6.0.25 /usr/lib/x86_64-linux-gnu/ && \
    rm -f /usr/lib/x86_64-linux-gnu/libstdc++.so.6 && \
    ln -s /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.25 /usr/lib/x86_64-linux-gnu/libstdc++.so.6

#Installs SSH
RUN apt-get update && apt-get install -y openssh-server net-tools sed supervisor && \
    mkdir -p /var/run/sshd && \
    mkdir -p /root/.ssh/ && \
    echo "root:12345678"|chpasswd && \
    sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
EXPOSE 22

#Installs MongoDB
ARG MONGO="mongodb-linux-x86_64-ubuntu1604-4.2.2"
RUN wget --quiet https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-4.2.2.tgz -O /usr/local/mongodb.tgz && \
    /usr/local/anaconda3/envs/py35/bin/pip install pymongo && \
    cd /usr/local && \
    tar zxvf /usr/local/mongodb.tgz && \
    rm /usr/local/mongodb.tgz && \
    mkdir -p /data/mongo/mongo_data && \
    chown -R 777 /data/mongo/mongo_data && \
    rm -rf /var/lib/apt/lists/*
COPY mongo.conf /usr/local/$MONGO/
ENV PATH=$PATH:/usr/local/$MONGO/bin
ENV AUTH yes
VOLUME ["/data"]
EXPOSE 27017

#Installs ROS
RUN apt-get update && apt-get install -y lsb-release dpkg && \
        sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list' && \
        apt-key adv --keyserver 'hkp://keyserver.ubuntu.com:80' --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654 && \
        apt-get update && apt-get install -y ros-kinetic-desktop-full && rosdep init && rosdep update
RUN echo "source /opt/ros/kinetic/setup.bash" >> ~/.bashrc && /bin/bash -c "source ~/.bashrc" && \ 
        apt install -y python-rosinstall python-rosinstall-generator python-wstool build-essential && \ 
        mkdir -p ~/SJTUSRL_ws/src

#Uses supervisord to open multi progress:sshd,mongodb
COPY supervisord.conf /etc/supervisor/
COPY supervisord_sshd.conf /etc/supervisor/
COPY supervisord_mongo.conf /etc/supervisor/
ENTRYPOINT ["/usr/bin/supervisord", "-nc", "/etc/supervisor/supervisord.conf"]
